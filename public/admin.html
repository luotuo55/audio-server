<!DOCTYPE html>
<html>
<head>
    <title>Audio Server Admin</title>
    <meta charset="UTF-8">
    <style>
        #loginForm, #adminPanel {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        #adminPanel {
            display: none;
        }
        
        .file-item {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        .file-item audio {
            width: 100%;
            margin: 10px 0;
        }
        
        .error {
            color: red;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="loginForm">
        <h2>管理员登录</h2>
        <input type="password" id="adminKey" placeholder="请输入管理员密钥" />
        <button onclick="verifyAdmin()">验证</button>
        <div id="loginError" class="error"></div>
    </div>

    <div id="adminPanel">
        <h2>文件管理</h2>
        <div id="fileList"></div>
    </div>

    <script>
    function verifyAdmin() {
        const keyInput = document.getElementById('adminKey');
        const key = keyInput.value.trim();
        const loginError = document.getElementById('loginError');
        
        if (!key) {
            loginError.textContent = '请输入管理员密钥';
            return;
        }
        
        console.log('开始验证管理员密钥...');
        
        fetch('/audio/api/admin/verify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ key: key })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`验证失败: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('验证成功:', data);
            localStorage.setItem('adminVerified', 'true');
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadFileList();
        })
        .catch(error => {
            console.error('验证错误:', error);
            loginError.textContent = '验证失败: ' + error.message;
            keyInput.value = '';
        });
    }

    function loadFileList() {
        fetch('/audio/api/admin/files')
        .then(response => response.json())
        .then(data => {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            data.files.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <p>文件名: ${file.filename}</p>
                    <p>原始文件名: ${file.original_filename}</p>
                    <p>大小: ${formatFileSize(file.file_size)}</p>
                    <p>上传时间: ${new Date(file.upload_time).toLocaleString()}</p>
                    <audio controls>
                        <source src="/audio/voice/${file.filename}" type="audio/mpeg">
                    </audio>
                    <button onclick="deleteFile('${file.filename}')">删除</button>
                `;
                fileList.appendChild(item);
            });
        })
        .catch(error => {
            console.error('加载文件列表失败:', error);
            alert('加载文件列表失败: ' + error.message);
        });
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    function deleteFile(filename) {
        if (!confirm(`确定要删除文件 ${filename} 吗？`)) {
            return;
        }
        
        fetch(`/audio/api/admin/file/${filename}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            alert('文件删除成功');
            loadFileList();
        })
        .catch(error => {
            console.error('删除文件失败:', error);
            alert('删除文件失败: ' + error.message);
        });
    }

    // 页面加载时检查验证状态
    document.addEventListener('DOMContentLoaded', function() {
        if (localStorage.getItem('adminVerified') === 'true') {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadFileList();
        }
    });
    </script>
    
    <footer class="footer">
        <p>Audio Server Admin v1.98</p>
    </footer>
</body>
</html> 
